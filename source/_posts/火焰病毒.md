---
title: [咨询]火焰病毒
date: 2022-02-26 14:07:24
---

# 火焰病毒

火焰病毒（Flame，也被称为Flamer或者Skywiper），2012年5月，俄罗斯卡巴斯基安全研究人员发现的一种新型的恶意软件，它主要在中东肆虐，可能针对中东的国家政府部门系统。火焰病毒是那时候最先进的病毒：超过20 MB的大小和超过20个攻击模块（一般的恶意软件包括网络嗅探、打开麦克风和文件获取等），而且使用轻量级关系型数据库（SQLite）和脚本语言（Lua）等组件。它以这种形式隐藏了相当长一段时间（意味着非常低的感染率或者无法被察觉到，很明显这不是一般水平的人能开发出来的）。

总的来说，火焰病毒在大约1000个系统中被发现，看起来是一种目标性非常明确的攻击。伊朗CERT于2012年5月份发表了一篇关于火焰病毒的新闻稿。不久之后，火焰病毒的创造者发出了自杀命令，让所有的火焰病毒将自身删除。不过之后还是发现了很多恶意软件存留，并且捕获和分析了几个命令和控制服务器的实例。

研究人员怀疑，火焰病毒与臭名昭著的恶意的“震网”(Stuxnet)病毒及其后继者Duqu病毒属于同一家族。火焰病毒将网络作战带入了一个新的阶段。

## 火焰病毒对抗Windows更新

火焰病毒对抗Windows更新之后发生的事情震惊了所有人。据报道，火焰病毒一个功能是攻击Windows的更新机制，可以传播到本地网络里面安装的任意Windows系统。更让人惊讶的部分是，**火焰病毒使用密码学**作为攻击手段来完成这次攻击。

一旦处于同一个本地网络，破坏Windows的更新机制就非常容易了。InternetExplorer支持Web代理自动发现机制（web proxy autodiscovery, WPAD），是一种可以让程序在本地网络自动找到HTTP代理服务器的协议。有本地网络访问权限的攻击者能够以代理的身份进行广播，从而获得受害者的HTTP(S)的流量。火焰病毒正是这样做的，而且包含一个简单的Web服务器去假装成Windows更新服务器，来广播带有恶意代码的可用“更新”。

## 火焰病毒对抗Windows终端服务

当Microsoft开始讨论遭到火焰病毒攻击的弱点的时候，一个更深藏的问题暴露了出来。为了运营终端服务许可（terminal services licensing），每台终端服务装置在激活的时候会收到特殊的二级CA证书。然后使用这个二级CA创建最终用户许可。Microsoft在设计系统的时候出现了以下几个严重的错误。

(1) 主终端服务CA证书（用来给每个单独的客户签发二级CA）与Windows更新CA一样，都是由同一个可信的根签发出来的。

(2) 父终端服务CA可以用于许可，以及出于一些无法解释的原因，用于代码签名。

(3) 二级CA证书没有用途限制，意味着对它们的约束限制与它们的父证书是一样的。

这些意味着每一个终端服务器用户都拥有一个不受限制的二级CA，这个CA可以用来给Windows更新的二进制文件进行签名，不需要任何的黑客行为。幸运的是，这些证书只能用于对付安装Windows XP的机器。二级CA证书包含了一个独有的X.509扩展，名为Hydra，被标记为关键扩展。Windows XP的代码在进行证书校验的时候忽略了这个关键扩展，但是从Windows Vista（于2007年1月30日在全球发布）以及之后的Windows版本开始，都能够理解这个关键性的扩展并且很好地处理它。也就是说火焰病毒的作者必须找到一种没有Hydra扩展的证书。

## 火焰病毒对抗MD5

Microsoft犯下的另外一个严重错误是在设计终端服务器许可协议的时候给证书用的是MD5签名。其他的错误（4.10.2节中讨论过的）相对来说没这么容易，并且需要对PKI的了解非常深入才能发现。但是在Microsoft设计系统的时候，MD5已经被广泛认为是不安全的。到了2008年，MD5的不安全性已经有了非常有效的证明--在对RapidSSL的攻击中生成了一张伪造的证书。从长远角度来看，Microsoft那时候根本就不应该在他们的证书程序里面允许MD5证书，但却将它们用在了终端服务许可上。

如果你阅读了前面讲的RapidSSL攻击以及伪造CA证书的生成过程，也许可以猜测到后面发生的事情：火焰病毒利用针对MD5的前缀选择碰撞攻击来生成一张伪造的CA证书。这次攻击原理上与之前介绍的RapidSSL攻击是一样的。下面是我们所知道的一些事情。

(1) 因为使用了不安全的MD5签名，所以可以对系统进行密码学相关的攻击。

(2) 证书签发过程是自动的，而且攻击者可以控制时间。除了证书有效期和序列号之外所有字段都可以事先知晓。

(3) 证书有效期只需要秒级精度，可以被预测。

(4) 序列号不像RapidSSL那样逐步加一，但也可以被预测（启动之后的毫秒数加上两个固定的字节和一个序列证书号），不过需要毫秒级精度。

对毫秒级别的精度要求可能让整个事情变得困难很多，因为需要一个非常好的网络连接来降低抖动。如果可以访问高性能计算集群将会加速碰撞搜索并提高准确性。我们无法得知需要尝试多少次（如果Microsoft很好地记录了许可行为，那么也许他们能够知道），不过攻击者最终显然是成功了。



无论是谁设计了火焰病毒并对Microsoft实施了攻击，他们一定有自己非常厉害的硬件、一个非常厉害的开发团队以及世界级的密码学家。